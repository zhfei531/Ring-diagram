<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>SVG</title>
    <style>
        #toolbox {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 250px;
            border-right: 1px solid #CCC;
        }

        #toolbox h2 {
            margin: 0;
            padding: 0;
            background: #EEE;
            font-size: 16px;
            height: 24px;
            line-height: 24px;
            padding: 5px 10px;
        }

        #toolbox form {
            padding: 10px;
        }

        #canvas {
            position: absolute;
            left: 260px;
            top: 10px;
            bottom: 10px;
            right: 10px;
            box-shadow: 2px 2px 10px rgba(0,0,0,.4);
            border-radius: 5px;
        }

        label {
            display: inline-block;
            width: 80px;
            text-align: left;
        }

	  circle.Node {
		stroke-width: 1.5px;
		cursor: pointer;
	}

	  button {
		background-color: rgb(246,246,245);
		cursor: pointer;
	}

    </style>
        <script src="d3.min.js" charset="utf-8"></script>
        <script src="jquery-2.2.3.min.js" charset="utf-8"></script>
        <script src="FileSaver.min.js" charset="utf-8"></script>		
</head>
<body>
    <div id="toolbox">
        <h2>文件</h2>
        <form id="file-shape">

            <button id="button10" type="button" title="新建" style="background:url(icon/openfile.png); border-style:2px; background-size:100% 100%;
                                                      width:25px; height:25px; "></button>
            <button id="button13" type="button" title="保存" style="background:url(icon/download.png); border-style:2px; 
                                                      width:25px; height:25px; "></button>  
            <button id="button1" type="button" title="后退" style="background:url(icon/backward.png); border-style:2px; background-size:100% 100%;
                                                      width:25px; height:25px; "></button>
            <button id="button2" type="button" title="前进" style="background:url(icon/forward.png); border-style:2px; background-size:100% 100%;
                                                      width:25px; height:25px; "></button><br/><br/>
            <input type="file" id="file" value="读取文件" onchange="getFilePath()" /> 

        </form>
        <h2>编辑</h2>
        <form id="edit-shape">
            <button id="button4" type="button" title="添加任务" style="background:url(icon/editaddcore.png); border-style:2px; background-size:100% 100%;
                                                      width:25px; height:25px; "></button>
            <button id="button20" type="button" title="添加文本框" style="background:url(icon/textbox.jpg); border-style:2px; background-size:100% 100%;
                                                      width:25px; height:25px; "></button>
            <button id="button6" type="button" title="添加直线" style="background:url(icon/editaddline.png); border-style:2px; 
                                                      width:25px; height:25px; "></button>
            <button id="button8" type="button" title="添加内层弧线" style="background:url(icon/editaddcurve.png); border-style:2px; 
                                                      width:25px; height:25px; "></button>
            <button id="button12" type="button" title="添加外层弧线" style="background:url(icon/editaddcircle.png); border-style:2px; background-size:100% 100%;
                                                      width:25px; height:25px; "></button>
            <button id="button3" type="button" title="删除" style="background:url(icon/brower.png); border-style:2px; background-size:100% 100%;
                                                      width:25px; height:25px; "></button><br/><br/>
        </form>
        <h2>属性</h2>
        <form id="property-attrs">
        </form>
    </div>
    <div id="canvas" style="width:1000px;height:600px"></div>
</body>

<script>
//文件读取              
function getFilePath(){  
	var filename = document.getElementById('file').value;
    if (!!window.ActiveXObject || "ActiveXObject" in window)
	{
		test = new window.ActiveXObject("Microsoft.XMLHTTP");
		test.open("GET",filename,true); 
		test.send(null);  
		if(test.readyState==4&&test.status==0){ 

		      src = JSON.parse(test.responseText); 
                  json_data = src;
			block_stack_undo = [];
			block_stack_redo = [];
			drawCircle(); 
		}
    }
	else{
		if (navigator.userAgent.indexOf("Chrome") > -1)
		{
			filename = filename.substring(12);
		}
		d3.json(filename, function(error, json){
			if(error){
				return console.error(error);
			}
			src = json;
			json_data = src;
			block_stack_undo = [];
			block_stack_redo = [];
			drawCircle(); 
		});
	}
	document.getElementById('file').value = '';
}  

var begin_minis = 0;
var end_minis = 0;
var begin_minis_again = 0;
var del_dot = null;
var del_line = null;
var del_arcline = null;
var arc_line_box = null;
var straight_line_box = null;

var attrForm = document.getElementById('property-attrs');

var width = 1000,
    height = 600,
    radius = (Math.min(width, height) / 2);

var selected = null;
var selected_d = null;

var src = [];
var json_data = [];
var pre_data = [];
var data=[];
var dot_data = [];
var longitude = [];
var latitude = [];
var blank = [];
var blank_dot_data = [];
var line_text_data = [];
var arc_text_data = [];

var draw_line = false;
var draw_arc = false;
var draw_outer_arc = false;

var line_start_r = 0;
var line_i = 0;
var line_o = 0;
var arc_start_a = 0;
var outer_arc_start_a = 0;
var draw_arc_ext = 0;

var drag_line = null;
var drag_arc = null;
var drag_outer_arc = null;

var cut = false;
var cut_arc = false;
var outer_draw = false;

var block_stack_undo = [];
var block_stack_redo = [];
var straight_stack_undo = [];
var straight_stack_redo = [];
var arc_stack_undo = [];
var arc_stack_redo = [];

var line_straight = [];
var line_arrow = [];

var outer_arc_start_key = 0;

var rect_h = 16;
var rect_w = 150;

var circle_button_time = 0;

var main = d3.select("#canvas").append("svg")
     .attr("width", width)
     .attr("height", height);

var svg = main.append("g")
     .attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")");

//var color=d3.scale.category20();
var color=["#F0E68C","#EEE8AA","#FFFACD","#FFE4B5","#F5DEB3","#FDF5E6","#FA8072","#FFE4E1","#DCDCDC"];
var color_node = d3.scale.category20c();
//射线箭头
svg.append('defs').append('svg:marker')
	    .attr('id', 'end-arrow')
	    .attr('viewBox', '0 -5 10 10')
	    .attr('refX', 6)
	    .attr('markerWidth', 6)
	    .attr('markerHeight', 6)
	    .attr('orient', 'auto')
	    .append('svg:path')
	    .attr('d', 'M0,-5L10,0L0,5')
	    .attr('fill', '#0000E3');
//块、纬线起始角度
function start(id)
{
	var i;
	for(i=0; i<longitude.length; i++)
	{
		if(longitude[i].key==id)
		{
			break;
		}
	}
      if(longitude[i])
	    return longitude[i].Angle;
      else
          return -2;
}
//块、纬线终止角度
function end(id)
{
	var i;
	for(i=0; i<longitude.length; i++)
	{
		if(longitude[i].key==id)
		{
			break;
		}
	}
	if(!longitude[i])
	{
		return -2;
	}
	if(longitude[i].Angle==0)
	{
		return 6.283185307179586;
	}
	else
	{
		return longitude[i].Angle;
	}
}
//块起止长度
function radiuslen(id)
{
	var i;
	for(i=0; i<latitude.length; i++)
	{
		if(latitude[i].key==id)
		{
			break;
		}
	}
      if(latitude[i])
	    return latitude[i].Radius;
      else
          return -2;
}
//经线长度
function longi(id)
{
	if(id==-1)
	{
            var max=0
            for(i=0; i<latitude.length; i++)
		{
			if(latitude[i].Radius>max)
			{
				max=latitude[i].Radius;
			}
		}
            return max+50;
		//return -1;
	}else{
		var i;
		for(i=0; i<latitude.length; i++)
		{
			if(latitude[i].key==id)
			{
				break;
			}
		}
		return latitude[i].Radius;
	}
}

var arc=d3.svg.arc();
var arcs=svg.append("g").attr("class", "Admin");

//绘图函数
function drawCircle(){

      var attrForm = document.getElementById('property-attrs');
      attrForm.innerHTML = "";
    	var pi2 = Math.PI/2;
    	var leng = 30;
      del_dot = null;
      del_line = null;
      del_arcline = null;
      arc_line_box = null;
      straight_line_box = null;
	  dot_data = [];//块里任务
      line_straight = [];//经线段
      line_arrow = [];//经射线
      blank_dot_data = [];//空白处任务
      var max_radius = 0;//弧最大长度
      arc_text_data = [];//纬线属性
      line_text_data = [];//经线属性

      data = json_data.data;
      longitude = json_data.longitude;
      latitude = json_data.latitude;
      blank = json_data.blank;
    //补全块属性
	for(var i=0; i<data.length; i++){
		data[i].startAngle=start(data[i].startlongitude);
		data[i].endAngle=end(data[i].endlongitude);
		data[i].innerRadius=radiuslen(data[i].innerlatitude);
		data[i].outerRadius=radiuslen(data[i].outerlatitude);
            var dots = data[i].dot;
            var dotnum = dots.length;
            for(var y=0; y<dots.length; y++){

                  var new_r = (data[i].outerRadius-data[i].innerRadius)*dots[y].rate1+data[i].innerRadius;
                  var new_a = (data[i].endAngle-data[i].startAngle)*dots[y].rate2+data[i].startAngle;
                  if(new_r-data[i].innerRadius<7){ new_r = data[i].innerRadius+7; }
                  if(data[i].outerRadius-new_r<7){ new_r = data[i].outerRadius-7; }
                  if(new_a-data[i].startAngle<0.1){ new_a = data[i].startAngle+0.1; }
                  if(data[i].endAngle-new_a<0.1){ new_a = data[i].endAngle-0.1; }

			dots[y].level=data[i].level;
			dots[y].id=data[i].id;
			dots[y].x=new_r*Math.cos(new_a-pi2);
			dots[y].y=new_r*Math.sin(new_a-pi2);
		      dot_data.push(dots[y]);
            	}
	}
	//补全经线属性
	for(var i=0; i<longitude.length; i++){
		longitude[i].innerRadius=longi(longitude[i].innerlatitude);
		longitude[i].outerRadius=longi(longitude[i].outerlatitude);
            if(longitude[i].outerlatitude==-1){
                line_arrow.push(longitude[i]);
            }else{
                line_straight.push(longitude[i]);
                }
            var x = longitude[i].textbox;
            for(var j=0; j<x.length; j++){
                x[j].innerRadius = longitude[i].innerRadius;
                x[j].outerRadius = longitude[i].outerRadius;
                x[j].arc = longitude[i].Angle;
                if(x[j].r<x[j].innerRadius){ x[j].r=x[j].innerRadius+5; }
                if(x[j].r>x[j].outerRadius){ x[j].r=x[j].outerRadius-5; }
                line_text_data.push(x[j]);
                }
	}
	//补全纬线属性
	for(var i=0; i<latitude.length; i++){
		latitude[i].startAngle=start(latitude[i].startlongitude);
		latitude[i].endAngle=end(latitude[i].endlongitude);
            if(latitude[i].Radius>max_radius){
                max_radius = latitude[i].Radius;
                }
            var x = latitude[i].textbox;
            for(var j=0; j<x.length; j++){
                x[j].startAngle = latitude[i].startAngle;
                x[j].endAngle = latitude[i].endAngle;
                x[j].r = latitude[i].Radius;
                x[j].arc = (x[j].endAngle-x[j].startAngle)*x[j].rate+x[j].startAngle;
                arc_text_data.push(x[j]);
                }
	}

	  //设置空白内外半径长度
      blank[0].innerRadius = max_radius;
      blank[0].outerRadius = max_radius+100;
	  //画布高度调整
	  if(max_radius>200)
	  {
	      height = (max_radius+100)*2;
	      $('#canvas').height(height);
		  main.attr("height", height);
		  svg.attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")");
	  }
	  //画布高度调整
	  if(max_radius<200)
	  {
	      height = 600;
	      $('#canvas').height(height);
		  main.attr("height", height);
		  svg.attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")");
	  }
	  //画布宽度调整
	  if(max_radius>400)
	  {
	      width = (max_radius+100)*2;
	      $('#canvas').width(width);
		  main.attr("width", width);
		  svg.attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")");
	  }
	  //画布宽度调整
	  if(max_radius<400)
	  {
	      width = 1000;
	      $('#canvas').width(width);
		  main.attr("width", width);
		  svg.attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")");
	  }
	  //补全空白处任务信息
      var b_dots = blank[0].dot;
      var b_dotnum = b_dots.length;
      for(var y=0; y<b_dots.length; y++){
		b_dots[y].startAngle=((b_dotnum-y)*blank[0].startAngle+y*blank[0].endAngle)/b_dotnum;
		b_dots[y].endAngle=((b_dotnum-y-1)*blank[0].startAngle+(y+1)*blank[0].endAngle)/b_dotnum;
		b_dots[y].innerRadius=blank[0].innerRadius;
		b_dots[y].outerRadius=blank[0].outerRadius;
	      blank_dot_data.push(b_dots[y]);
    	}
	

//外层空白

 
    var blank_g = arcs.selectAll("g.Blankspace").data(blank);
    blank_g.select("path").attr("d", function(d){ return arc(d);});
    var bspace = blank_g.enter().append("g").attr("class", "Blankspace");
    bspace.append("path")   
	  .attr("d", function(d){ return arc(d);})
        .style("fill", "white");
    blank_g.exit().transition()  
                .duration(400)    
                .remove();

//圆心
    var center_r=2048;
    for(i=0; i<latitude.length; i++)
     {
        if(latitude[i].Radius<center_r)
	  {
		center_r=latitude[i].Radius;
          }
     }

    arcs.selectAll("g.Center").remove();
    var center = arcs.append("g").attr("class", "Center");
    center.append("circle")      
        .attr("r", center_r)
        .style("fill", "white")
        .attr("stroke-width",1) 
        .attr("cursor", "pointer")
        .on("click", function(d){  
            if(((new Date()).getTime()-circle_button_time)>300){
                circle_button_time = (new Date()).getTime();
		    var attrForm = document.getElementById('property-attrs');
		    attrForm.innerHTML = "";
		    var label = document.createElement('label');
		    label.textContent = "圆心属性：";
		    var handle1 = document.createElement('input');
		    handle1.value = json_data.info;
		    var btn = document.createElement('input');
		    btn.type='button';
                btn.setAttribute("style","background:url(icon/commit.png); border-style:2px; background-size:100% 100%; width:25px; height:25px; ");
		    btn.addEventListener('click', function(){
			      var rate1 = handle1.value;
			      if(!rate1) return;
                        json_data.info = rate1;	
				  //attrForm.innerHTML = "";
			      drawCircle();
		      });
		    attrForm.appendChild(label);
		    attrForm.appendChild(handle1);
		    attrForm.appendChild(btn);
		    handle1.focus();
            }else{
		    if(json_data.infonum==1){		
			    var attrForm = document.getElementById('property-attrs');
			    attrForm.innerHTML = "";
			    var label = document.createElement('label');
			    label.textContent = "圆心属性：";
			    var handle1 = document.createElement('input');
			    handle1.value = json_data.info;
			    var btn = document.createElement('input');
			    btn.type='button';
		        btn.setAttribute("style","background:url(icon/commit.png); border-style:2px; background-size:100% 100%; width:25px; height:25px; ");
			    btn.addEventListener('click', function(){
				      var rate1 = handle1.value;
				      if(!rate1) return;
		                json_data.info = rate1;	
					  //attrForm.innerHTML = "";
				      drawCircle();
			      });
			    attrForm.appendChild(label);
			    attrForm.appendChild(handle1);
			    attrForm.appendChild(btn);
			    handle1.focus();
		    }else{
		        json_data = pre_data.pop();
		        drawCircle();
		       }
                }

	      del_arcline = null;
            del_dot = null;
            arc_line_box = null;
            straight_line_box = null;
			arcs.selectAll(".Box")
                  .attr("stroke", "black");
            arcs.selectAll(".L_Box")
                  .attr("stroke", "blue");
            arcs.selectAll(".Node")
                  .attr("stroke", "black");
            arcs.selectAll(".arc_line")
                  .attr("fill", "black");
            arcs.selectAll(".arrow_line")
                  .attr("stroke", "blue");
            arcs.selectAll(".straight_line")
                  .attr("stroke", "blue");
	   });
    
    center.append("text")
         .style("font-size", "16px")  
         .style("font-family", "simsun")  
         .attr("cursor", "pointer")
         .attr("text-anchor","middle")  	
         .attr("transform","translate(0,5)")
         .on("click", function(d){  
            if(((new Date()).getTime()-circle_button_time)>300){
                circle_button_time = (new Date()).getTime();
		    var attrForm = document.getElementById('property-attrs');
		    attrForm.innerHTML = "";
		    var label = document.createElement('label');
		    label.textContent = "圆心属性：";
		    var handle1 = document.createElement('input');
		    handle1.value = json_data.info;
		    var btn = document.createElement('input');
		    btn.type='button';
                btn.setAttribute("style","background:url(icon/commit.png); border-style:2px; background-size:100% 100%; width:25px; height:25px; ");
		    btn.addEventListener('click', function(){
			      var rate1 = handle1.value;
			      if(!rate1) return;
                        json_data.info = rate1;	
				  //attrForm.innerHTML = "";
			      drawCircle();
		      });
		    attrForm.appendChild(label);
		    attrForm.appendChild(handle1);
		    attrForm.appendChild(btn);
		    handle1.focus();
            }else{

		    if(json_data.infonum==1){			
			    var attrForm = document.getElementById('property-attrs');
			    attrForm.innerHTML = "";
			    var label = document.createElement('label');
			    label.textContent = "圆心属性：";
			    var handle1 = document.createElement('input');
			    handle1.value = json_data.info;
			    var btn = document.createElement('input');
			    btn.type='button';
		        btn.setAttribute("style","background:url(icon/commit.png); border-style:2px; background-size:100% 100%; width:25px; height:25px; ");
			    btn.addEventListener('click', function(){
				      var rate1 = handle1.value;
				      if(!rate1) return;
		                json_data.info = rate1;	
					//attrForm.innerHTML = "";
				      drawCircle();
				  
			      });
			    attrForm.appendChild(label);
			    attrForm.appendChild(handle1);
			    attrForm.appendChild(btn);
			    handle1.focus();
		    }else{
		        json_data = pre_data.pop();
		        drawCircle();
		       }
                }
	      del_arcline = null;
            del_dot = null;
            arc_line_box = null;
            straight_line_box = null;
			arcs.selectAll(".Box")
                  .attr("stroke", "black");
            arcs.selectAll(".L_Box")
                  .attr("stroke", "blue");
            arcs.selectAll(".Node")
                  .attr("stroke", "black");
            arcs.selectAll(".arc_line")
                  .attr("fill", "black");
            arcs.selectAll(".arrow_line")
                  .attr("stroke", "blue");
            arcs.selectAll(".straight_line")
                  .attr("stroke", "blue");
	    })
	   .text(json_data.info); 

//扇环区块
    var area_g = arcs.selectAll("g.Block").data(data);
    area_g.select("path").transition()  
        .duration(400)
        .attr("fill",function(d){	
//		return d3.rgb(color(d.level)).brighter(0.5); 
            return color[d.level%9];	
	   })  	
        .style("opacity", 0.8)
	  .attr("d", function(d){ return arc(d);});
    var area = area_g.enter().append("g").attr("class", "Block");
    area.append("path")
	  .attr("fill",function(d){	
//		return d3.rgb(color(d.level)).brighter(0.5); 
            return color[d.level%9]; 	
	  })  	
        .attr("class", "Arc")
        .style("opacity", 0.8)
	  .attr("d", function(d){ return arc(d);})
        .attr("stroke", "gray")
        .on("mouseover", function(d, i){
            d3.select(this).style("opacity", 1);
          })
        .on("mouseout", function(d, i){
            d3.select(this).style("opacity", 0.8);
          })
        .on("mousedown", function(d){

          if(cut_arc == true){
              draw_arc = true;
	        var sA = d.startAngle;
	        var eA = d.endAngle;
              arc_start_a = sA;
              line_i = d.innerRadius;
              line_o = d.outerRadius;
              var d_x = d3.mouse(this)[0];
              var d_y = d3.mouse(this)[1];
	        var dist = Math.sqrt(d_x*d_x+d_y*d_y);
draw_arc_ext = dist;
		  var l_sin = d_y/dist;
		  var a_sin = Math.asin(l_sin)+ Math.PI/2;
		  if(d_x<0){a_sin = Math.PI*2-a_sin;}
		  var anglePath = d3.svg.arc()
		     .outerRadius(dist+1)
		     .innerRadius(dist)
		     .startAngle(sA)
		     .endAngle(a_sin);
              drag_arc = svg.append("path")
		     .attr("class", "Commun")
		     .attr("d", anglePath)
		     .style("stroke", "#0000E3");
              }
          if(cut == true){
		  draw_line = true;
		  var sA = d.startAngle;
		  var eA = d.endAngle;
		  var d_x = d3.mouse(this)[0];
		  var d_y = d3.mouse(this)[1];
		  var d_r = d.innerRadius;
		  line_start_r = d_r;
		  var dist = Math.sqrt(d_x*d_x+d_y*d_y);

		  var sourcex = 0+d_r*(d_x-0)/dist;
		  var sourcey = 0+d_r*(d_y-0)/dist;
		  drag_line = svg.append("line").attr("x1", sourcex).attr("y1", sourcey).attr("x2", d_x).attr("y2", d_y)
			     .attr("class","Commun")  
			     .attr("stroke","#0000E3")  
			     .attr("stroke-width",2);
              }
         });
    area_g.exit().transition()  
                .duration(400)    
                .remove(); 

// 弧线
    arcs.selectAll("g.Arcline").remove();
    var arc_g = arcs.selectAll("g.Arcline").data(latitude);
    var limit_inn = 0;
    var limit_out = 0;

    var arcline_drag = d3.behavior.drag()
                    .origin(function(){ return {x: d3.select(this).attr("cx"), y:d3.select(this).attr("cy")}; } )
                    .on("dragstart", function(d){
						var attrForm = document.getElementById('property-attrs');
						attrForm.innerHTML = "";
                        d3.select(this).attr("fill", "yellow");
                        arcs.selectAll(".Box")
                              .attr("stroke", "black");
                        arcs.selectAll(".L_Box")
                              .attr("stroke", "blue");
                        arcs.selectAll(".Node")
                              .attr("stroke", "black");
                        arcs.selectAll(".arc_line")
                              .filter(function(e) {
	                            return (e.key != d.key);
	                               })
                              .attr("fill", "black");
                        arcs.selectAll(".arrow_line")
                              .attr("stroke", "blue");
                        arcs.selectAll(".straight_line")
                              .attr("stroke", "blue");

                        var a = d.startAngle;
                        var b = d.endAngle;
                        var r = d.Radius;
                        var inner_r = 2048;
                        var outer_r = 2048;
   
                        for(var i=0; i<latitude.length; i++ ){
                            if((latitude[i].startAngle<=a && latitude[i].endAngle>a)||(latitude[i].startAngle<b && latitude[i].endAngle>=b)||(latitude[i].startAngle<=a && latitude[i].endAngle>=b)||(latitude[i].startAngle>a && latitude[i].endAngle<b)){
                                if(latitude[i].Radius<r && (r-latitude[i].Radius)<inner_r){
                                    inner_r = r-latitude[i].Radius;
                                           }
                                if(latitude[i].Radius>r && (latitude[i].Radius-r)<outer_r){
                                    outer_r = latitude[i].Radius-r;
                                           }
                                     }
                                }
                        limit_inn = r - inner_r  + 10;
                        limit_out = r + outer_r  - 10;
                        begin_minis = (new Date()).getTime();
                           })
                    .on("dragend", function(d){
                          end_minis=(new Date()).getTime(); 
                          if(end_minis-begin_minis<300){  
                              del_arcline = d;
                              arc_line_box = null;
                              straight_line_box = null;
                              del_dot = null;
                              del_line = null;
                              return;
                                  }

				 var temp= JSON.parse(JSON.stringify(json_data));
				 block_stack_undo.push(temp);

				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 if(dist>limit_out){ dist=limit_out;}
				 if(dist<limit_inn){ dist=limit_inn;}
                         d.Radius = dist;
                         drawCircle(); 
                           })
                    .on("drag", function(d){
				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 if(dist>limit_out){ dist=limit_out;}
				 if(dist<limit_inn){ dist=limit_inn;}

			       var aPath = d3.svg.arc()
			           .outerRadius(function(d){ return dist+1;} )
			           .innerRadius(function(d){ return dist;} )
			           .startAngle(function(d){ return d.startAngle;} )
			           .endAngle(function(d){ return d.endAngle;} );
			       d3.select(this)  
			           .attr("d", aPath); 
                           });

    var anglePath = d3.svg.arc()
       .outerRadius(function(d){ return d.Radius-1;} )
       .innerRadius(function(d){ return d.Radius;} )
       .startAngle(function(d){ return d.startAngle;} )
       .endAngle(function(d){ return d.endAngle;} );

    arc_g.select("path").transition()  
        .duration(200)
        .attr("d", anglePath);

    var arc_line = arc_g.enter().append("g").attr("class", "Arcline");
    arc_line.append("path")
	  .attr("fill", "black")
        .attr("class", "arc_line")
        .attr("cursor", "pointer")
	  .attr("d", anglePath)
        .call(arcline_drag);

    arc_g.exit().transition()  
                .duration(400)    
                .remove(); 

// 带箭头的直线
    arcs.selectAll("g.Arrowline").remove();
    var arrow_g = arcs.selectAll("g.Arrowline").data(line_arrow);

    var arrow_limit_start = 0;
    var arrow_limit_end = 0;

    var arrowline_drag = d3.behavior.drag()
                    .origin(function(){ return {x: d3.select(this).attr("cx"), y:d3.select(this).attr("cy")}; } )
                    .on("dragstart", function(d){
						var attrForm = document.getElementById('property-attrs');
						attrForm.innerHTML = "";

                        d3.select(this).attr("stroke", "yellow");
                        arcs.selectAll(".Box")
                              .attr("stroke", "black");
                        arcs.selectAll(".L_Box")
                              .attr("stroke", "blue");
                        arcs.selectAll(".Node")
                              .attr("stroke", "black");
                        arcs.selectAll(".arc_line")
                              .attr("fill", "black");
                        arcs.selectAll(".arrow_line")
                              .filter(function(e) {
	                            return (e.key != d.key);
	                               })
                              .attr("stroke", "blue");
                        arcs.selectAll(".straight_line")
                              .attr("stroke", "blue");


                        var i = d.innerRadius;
                        var o = d.outerRadius;
                        var a = d.Angle;
                        var start_a = 7;
                        var end_a = Math.PI*2;
   
                        for(var i=0; i<longitude.length; i++ ){
                            if((longitude[i].innerRadius<=i && longitude[i].outerRadius>i)||(longitude[i].innerRadius<o && longitude[i].outerRadius>=o)||(longitude[i].innerRadius<=i && longitude[i].outerRadius>=o)||(longitude[i].innerRadius>i && longitude[i].outerRadius<o)){
                                if(longitude[i].Angle<a && (a-longitude[i].Angle)<start_a){
                                    start_a = a-longitude[i].Angle;
                                           }
                                if(longitude[i].Angle>a && (longitude[i].Angle-a)<end_a){
                                    end_a = longitude[i].Angle-a;
                                           }
                                     }
                                }
                        arrow_limit_start = a - start_a  + 10/d.outerRadius;
                        arrow_limit_end = a + end_a  - 10/d.outerRadius;
                        begin_minis = (new Date()).getTime();
                           })
                    .on("dragend", function(d){
                         end_minis=(new Date()).getTime(); 
                         if(end_minis-begin_minis<300){  
                              del_arcline = null;
                              del_dot = null;
                              arc_line_box = null;
                              straight_line_box = null;
                              del_line = d;
                              return;
                                 }
                         if(d.Angle==0){ drawCircle(); return null; };

				 var temp= JSON.parse(JSON.stringify(json_data));
				 block_stack_undo.push(temp);

				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var l_sin = d_y/dist;
				 var a_sin = Math.asin(l_sin)+ Math.PI/2;
				 if(d_x<0){a_sin = Math.PI*2-a_sin;}
				 if(a_sin>arrow_limit_end){ a_sin=arrow_limit_end};
				 if(a_sin<arrow_limit_start){ a_sin=arrow_limit_start};
                         d.Angle = a_sin;
                         drawCircle(); 
                           })
                    .on("drag", function(d){
                         if(d.Angle==0){ return null; };
				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var l_sin = d_y/dist;
				 var a_sin = Math.asin(l_sin)+ Math.PI/2;
				 if(d_x<0){a_sin = Math.PI*2-a_sin;}
				 if(a_sin>arrow_limit_end){ 
                             a_sin=arrow_limit_end;
				     d3.select(this)  
					      .attr("x1" ,function(d){  		
						    return d.innerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y1" ,function(d){   		
						    return d.innerRadius*Math.sin(a_sin-pi2);
						})   
					      .attr("x2" ,function(d){  
						    return d.outerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y2" ,function(d){   		
						    return d.outerRadius*Math.sin(a_sin-pi2);
						});
                         }else if(a_sin<arrow_limit_start){
                             a_sin=arrow_limit_start;
				     d3.select(this)  
					      .attr("x1" ,function(d){  		
						    return d.innerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y1" ,function(d){   		
						    return d.innerRadius*Math.sin(a_sin-pi2);
						})   
					      .attr("x2" ,function(d){  
						    return d.outerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y2" ,function(d){   		
						    return d.outerRadius*Math.sin(a_sin-pi2);
						});
                         }else{
				     d3.select(this)  
					      .attr("x1" ,function(d){  		
						    return d.innerRadius*d_x/dist;
						})  
					      .attr("y1" ,function(d){   		
						    return d.innerRadius*d_y/dist;
						})   
					      .attr("x2" ,function(d){  
						    return d.outerRadius*d_x/dist;
						})  
					      .attr("y2" ,function(d){   		
						    return d.outerRadius*d_y/dist;
						});
                                 }
                           });

    var arrow_line = arrow_g.enter().append("g").attr("class", "Arrowline");
    arrow_line.append("line")
	      .attr("x1" ,function(d){  		
		    return d.innerRadius*Math.cos(d.Angle-pi2);
		})  
	      .attr("y1" ,function(d){   		
		    return d.innerRadius*Math.sin(d.Angle-pi2);
		})   
	      .attr("x2" ,function(d){  		
		    return d.outerRadius*Math.cos(d.Angle-pi2);
		})  
	      .attr("y2" ,function(d){   				
		    return d.outerRadius*Math.sin(d.Angle-pi2);
		})
            .attr("cursor", function(d){ return "pointer"; })
	      .attr("stroke","blue")  
            .attr("class", "arrow_line")
	      .attr("stroke-width",2)
	      .attr("marker-end","url(#end-arrow)")
            .call(arrowline_drag); 

    arrow_g.exit().transition()  
                .duration(400)    
                .remove(); 

// 直线
    arcs.selectAll("g.Straightline").remove();
    var straight_g = arcs.selectAll("g.Straightline").data(line_straight);

    var limit_start = 0;
    var limit_end = 0;

    var straightline_drag = d3.behavior.drag()
                    .origin(function(){ return {x: d3.select(this).attr("cx"), y:d3.select(this).attr("cy")}; } )
                    .on("dragstart", function(d){
						var attrForm = document.getElementById('property-attrs');
						attrForm.innerHTML = "";

                        d3.select(this).attr("stroke", "yellow");
                        arcs.selectAll(".Box")
                              .attr("stroke", "black");
                        arcs.selectAll(".L_Box")
                              .attr("stroke", "blue");
                        arcs.selectAll(".Node")
                              .attr("stroke", "black");
                        arcs.selectAll(".arc_line")
                              .attr("fill", "black");
                        arcs.selectAll(".arrow_line")
                              .attr("stroke", "blue");
                        arcs.selectAll(".straight_line")
                              .filter(function(e) {
	                            return (e.key != d.key);
	                               })
                              .attr("stroke", "blue");

                        var i = d.innerRadius;
                        var o = d.outerRadius;
                        var a = d.Angle;
                        var start_a = 7;
                        var end_a = Math.PI*2;
   
                        for(var i=0; i<longitude.length; i++ ){
                            if((longitude[i].innerRadius<=i && longitude[i].outerRadius>i)||(longitude[i].innerRadius<o && longitude[i].outerRadius>=o)||(longitude[i].innerRadius<=i && longitude[i].outerRadius>=o)||(longitude[i].innerRadius>i && longitude[i].outerRadius<o)){
                                if(longitude[i].Angle<a && (a-longitude[i].Angle)<start_a){
                                    start_a = a-longitude[i].Angle;
                                           }
                                if(longitude[i].Angle>a && (longitude[i].Angle-a)<end_a){
                                    end_a = longitude[i].Angle-a;
                                           }
                                     }
                                }
                        limit_start = a - start_a  + 10/d.outerRadius;
                        limit_end = a + end_a  - 10/d.outerRadius;
                        begin_minis = (new Date()).getTime();
                           })
                    .on("dragend", function(d){
                         end_minis=(new Date()).getTime(); 
                         if(end_minis-begin_minis<300){  
                              del_arcline = null;
                              del_dot = null;
                              arc_line_box = null;
                              straight_line_box = null;
                              del_line = d;
                              return;
                                 }

				 var temp= JSON.parse(JSON.stringify(json_data));
				 block_stack_undo.push(temp);

				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var l_sin = d_y/dist;
				 var a_sin = Math.asin(l_sin)+ Math.PI/2;
				 if(d_x<0){a_sin = Math.PI*2-a_sin;}
				 if(a_sin>limit_end){ a_sin=limit_end};
				 if(a_sin<limit_start){ a_sin=limit_start};
                         d.Angle = a_sin;
                         drawCircle(); 
                           })
                    .on("drag", function(d){
				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var l_sin = d_y/dist;
				 var a_sin = Math.asin(l_sin)+ Math.PI/2;
				 if(d_x<0){a_sin = Math.PI*2-a_sin;}
				 if(a_sin>limit_end){ 
                             a_sin=limit_end;
				     d3.select(this)  
					      .attr("x1" ,function(d){  		
						    return d.innerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y1" ,function(d){   		
						    return d.innerRadius*Math.sin(a_sin-pi2);
						})   
					      .attr("x2" ,function(d){  
						    return d.outerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y2" ,function(d){   		
						    return d.outerRadius*Math.sin(a_sin-pi2);
						});
                         }else if(a_sin<limit_start){
                             a_sin=limit_start;
				     d3.select(this)  
					      .attr("x1" ,function(d){  		
						    return d.innerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y1" ,function(d){   		
						    return d.innerRadius*Math.sin(a_sin-pi2);
						})   
					      .attr("x2" ,function(d){  
						    return d.outerRadius*Math.cos(a_sin-pi2);
						})  
					      .attr("y2" ,function(d){   		
						    return d.outerRadius*Math.sin(a_sin-pi2);
						});
                         }else{
				     d3.select(this)  
					      .attr("x1" ,function(d){  		
						    return d.innerRadius*d_x/dist;
						})  
					      .attr("y1" ,function(d){   		
						    return d.innerRadius*d_y/dist;
						})   
					      .attr("x2" ,function(d){  
						    return d.outerRadius*d_x/dist;
						})  
					      .attr("y2" ,function(d){   		
						    return d.outerRadius*d_y/dist;
						});
                                 }
                           });

    straight_g.select("line").transition()  
            .duration(200)
	      .attr("x1" ,function(d){  		
		    return d.innerRadius*Math.cos(d.Angle-pi2);
		})  
	      .attr("y1" ,function(d){   		
		    return d.innerRadius*Math.sin(d.Angle-pi2);
		})   
	      .attr("x2" ,function(d){  
		    return d.outerRadius*Math.cos(d.Angle-pi2);
		})  
	      .attr("y2" ,function(d){   		
		    return d.outerRadius*Math.sin(d.Angle-pi2);
		});

    var straight_line = straight_g.enter().append("g").attr("class", "Straightline");
    straight_line.append("line")
	      .attr("x1" ,function(d){  		
		    return d.innerRadius*Math.cos(d.Angle-pi2);
		})  
	      .attr("y1" ,function(d){   		
		    return d.innerRadius*Math.sin(d.Angle-pi2);
		})   
	      .attr("x2" ,function(d){  	
		    return d.outerRadius*Math.cos(d.Angle-pi2);
		})  
	      .attr("y2" ,function(d){   		
		    return d.outerRadius*Math.sin(d.Angle-pi2);
		})
            .attr("cursor", "pointer")
            .attr("class", "straight_line")
	      .attr("stroke","blue")  
	      .attr("stroke-width",1)
            .call(straightline_drag);  

    straight_g.exit().transition()  
                .duration(400)    
                .remove(); 

// 弧线的文本框
    arcs.selectAll("g.Arc_Box").remove();
    var arc_box_g = arcs.selectAll("g.Arc_Box").data(arc_text_data);

    var arc_box_drag = d3.behavior.drag()
                    .on("dragstart", function(d){
						//var attrForm = document.getElementById('property-attrs');
						//attrForm.innerHTML = "";
                        arcs.selectAll(".Box")
                              .attr("stroke", "black");
                        arcs.selectAll(".L_Box")
                              .attr("stroke", "blue");
                        d3.select(this).select("rect").attr("stroke", "green");
                        arcs.selectAll(".Node")
                              .attr("stroke", "black");
                        arcs.selectAll(".arc_line")
                              .attr("fill", "black");
                        arcs.selectAll(".arrow_line")
                              .attr("stroke", "blue");
                        arcs.selectAll(".straight_line")
                              .attr("stroke", "blue");
                        begin_minis = (new Date()).getTime();
                           })
                    .on("dragend", function(d){
                          end_minis=(new Date()).getTime(); 
                          if(end_minis-begin_minis<300){  
                              Show_info(d);
                              del_dot = null;
                              del_arcline = null;
                              del_line = null;
                              arc_line_box = d;
                              straight_line_box = null;
                              return;
                                  }

                         var temp= JSON.parse(JSON.stringify(json_data));
                         block_stack_undo.push(temp);

				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var l_sin = d_y/dist;
				 var a_sin = Math.asin(l_sin)+ Math.PI/2;
				 if(d_x<0){a_sin = Math.PI*2-a_sin;}
				 if(a_sin>d.endAngle){ a_sin=d.endAngle; }
				 if(a_sin<d.startAngle){ a_sin=d.startAngle; }
                         d.arc = a_sin;
                         d.rate = (a_sin-d.startAngle)/(d.endAngle-d.startAngle)
                         drawCircle();
                           })
                    .on("drag", function(d){
				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var l_sin = d_y/dist;
				 var a_sin = Math.asin(l_sin)+ Math.PI/2;
				 if(d_x<0){a_sin = Math.PI*2-a_sin;}
				 if(a_sin>d.endAngle){ a_sin=d.endAngle; }
				 if(a_sin<d.startAngle){ a_sin=d.startAngle; }

                         var a1=d.r*Math.cos(a_sin-pi2);
                         var b1=d.r*Math.sin(a_sin-pi2);
			       d3.select(this).select("rect")
                             .attr('x', function(d){
                                 if(a1<0){
                                     return a1-(rect_w-80);
                                 }else{
                                     return a1;
                                            }
                                      })  
                             .attr('y', function(d){
                                 if(b1<0){
                                     return b1-rect_h;
                                 }else{
                                     return b1;
                                            }
                                     });  
			       d3.select(this).select("text")
                             .attr('x', function(d){
                                 if(a1<0){
                                     return a1-(rect_w-80)/2;;
                                 }else{
                                     return a1+(rect_w-80)/2;
                                            }
                                      })  
                             .attr('y', function(d){
                                 if(b1<0){
                                     return b1-rect_h/2+4;
                                 }else{
                                     return b1+rect_h/2+4;
                                            }
                                     });  
			       d3.select(this).select("circle")
                             .attr('cx', a1)  
                             .attr('cy', b1);  
                           }); 

    var arc_box = arc_box_g.enter().append("g")
        .attr("class", "Arc_Box")
        .attr("cursor", "pointer")
        .call(arc_box_drag);

    arc_box.append("rect")
        .attr("class", "Box")
        .style('fill', "white")  
        .attr('x', function(d){
             var a1=d.r*Math.cos(d.arc-pi2);

             if(a1<0){
                 return a1-(rect_w-80);
             }else{
                 return a1;
                 }
           })  
        .attr('y', function(d){
             var b1=d.r*Math.sin(d.arc-pi2);
             if(b1<0){
                 return b1-rect_h;
             }else{
                 return b1;
                 }
           })  
        .attr("stroke", "black") 
        .attr('width',rect_w-80)  
        .attr('height',rect_h);

    arc_box.append("circle")
        .attr("class", "Black")
        .attr("cx", function(d){ return d.r*Math.cos(d.arc-pi2); })  
        .attr("cy", function(d){ return d.r*Math.sin(d.arc-pi2); })  
        .attr("r", 3)
        .attr("fill", "black") 
        .attr("stroke", "black");

    arc_box.append("text")
        .attr("class", "Boxtext")
        .style("font-size", "12px") 
        .attr("text-anchor", "middle") 
        .attr('x', function(d){
             var a1=d.r*Math.cos(d.arc-pi2);
             if(a1<0){
                 return a1-(rect_w-80)/2;
             }else{
                 return a1+(rect_w-80)/2;
                 }
           })  
        .attr('y', function(d){
             var b1=d.r*Math.sin(d.arc-pi2);
             if(b1<0){
                 return b1-rect_h/2+4;
             }else{
                 return b1+rect_h/2+4;
                 }
           })
	  .text(function(d){  
             if(d.content.length>4){ return (d.content.substr(0,4)+'...'); }		
	       else{ return d.content; }		
	   }) 
    
    arc_box_g.exit().transition()  
                .duration(400)    
                .remove(); 

//straight_line 的文本框
    arcs.selectAll("g.Line_Box").remove();
    var line_box_g = arcs.selectAll("g.Line_Box").data(line_text_data);

    var line_box_drag = d3.behavior.drag()
                    .on("dragstart", function(d){
						//var attrForm = document.getElementById('property-attrs');
						//attrForm.innerHTML = "";
                        arcs.selectAll(".Box")
                              .attr("stroke", "black");
                        arcs.selectAll(".L_Box")
                              .attr("stroke", "blue");
                        d3.select(this).select("rect").attr("stroke", "green");
                        arcs.selectAll(".Node")
                              .attr("stroke", "black");
                        arcs.selectAll(".arc_line")
                              .attr("fill", "black");
                        arcs.selectAll(".arrow_line")
                              .attr("stroke", "blue");
                        arcs.selectAll(".straight_line")
                              .attr("stroke", "blue");
                        begin_minis = (new Date()).getTime();
                           })
                    .on("dragend", function(d){
                          end_minis=(new Date()).getTime(); 
                          if(end_minis-begin_minis<300){  
                              Show_info(d);
                              del_dot = null;
                              del_arcline = null;
                              del_line = null;
                              arc_line_box = null;
                              straight_line_box = d;
                              return;
                                  }

                         var temp= JSON.parse(JSON.stringify(json_data));
                         block_stack_undo.push(temp);

				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var a_sin = d.Angle;
				 if(dist<d.innerRadius){ dist=d.innerRadius; }
				 if(dist>d.outerRadius){ dist=d.outerRadius; }
                         d.r = dist;
                         drawCircle();
                           })
                    .on("drag", function(d){
				 var d_x = d3.mouse(this)[0];
				 var d_y = d3.mouse(this)[1];
				 var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				 var a_sin = d.arc;
				 if(dist<d.innerRadius){ dist=d.innerRadius; }
				 if(dist>d.outerRadius){ dist=d.outerRadius; }

                         var a1=dist*Math.cos(a_sin-pi2);
                         var b1=dist*Math.sin(a_sin-pi2);
			       d3.select(this).select("rect")
                             .attr('x', function(d){
								if(b1<0){ return a1-(rect_w-80); }
								else{ return a1; }
                             })  
                             .attr('y', function(d){
								if(a1<0){ return b1; }
								else{ return b1-rect_h; }
                             });  
			       d3.select(this).select("text")
                             .attr('x', function(d){
								if(b1<0){ return a1-(rect_w-80)/2; }
								else{ return a1+(rect_w-80)/2; }
                             })  
                             .attr('y', function(d){
								if(a1<0){ return b1+rect_h/2+4; }
								else{ return b1-rect_h/2+4; }
                             });  
			       d3.select(this).select("circle")
                             .attr('cx', a1)  
                             .attr('cy', b1);  
                           }); 

    var line_box = line_box_g.enter().append("g")
        .attr("class", "Line_Box")
        .attr("cursor", "pointer")
        .call(line_box_drag);

    line_box.append("rect")
        .attr("class", "L_Box")
        .style('fill', "white")  
        .attr('x', function(d){
             var a1=d.r*Math.cos(d.arc-pi2);
             var b1=d.r*Math.sin(d.arc-pi2);
			 if(b1<0){ return a1-(rect_w-80); }
			 else{ return a1; }
           })  
        .attr('y', function(d){
		     var a1=d.r*Math.cos(d.arc-pi2);
             var b1=d.r*Math.sin(d.arc-pi2);
			 if(a1<0){ return b1; }
			 else{ return b1-rect_h; }
           })  
        .attr("stroke", "blue") 
        .attr('width',rect_w-80)  
        .attr('height',rect_h);

    line_box.append("circle")
        .attr("class", "Black")
        .attr("cx", function(d){ return d.r*Math.cos(d.arc-pi2); })  
        .attr("cy", function(d){ return d.r*Math.sin(d.arc-pi2); })  
        .attr("r", 3)
        .attr("fill", "blue");


    line_box.append("text")
        .attr("class", "Boxtext")
        .style("font-size", "12px") 
        .attr("text-anchor", "middle") 
        .attr('x', function(d){
		     var a1=d.r*Math.cos(d.arc-pi2);
             var b1=d.r*Math.sin(d.arc-pi2);
			 if(b1<0){ return a1-(rect_w-80)/2; }
			 else{ return a1+(rect_w-80)/2; }
           })  
        .attr('y', function(d){
		     var a1=d.r*Math.cos(d.arc-pi2);
             var b1=d.r*Math.sin(d.arc-pi2);
			 if(a1<0){ return b1+rect_h/2+4; }
			 else{ return b1-rect_h/2+4; }
           })
	  .text(function(d){  
             if(d.content.length>4){ return (d.content.substr(0,4)+'...'); }		
	       else{ return d.content; }		
	   }) 
    
    line_box_g.exit().transition()  
                .duration(400)    
                .remove(); 

//圆点
    arcs.selectAll("g.Dot").remove();
    var dot_g = arcs.selectAll("g.Dot").data(dot_data);

    var dot_drag = d3.behavior.drag()
                    .origin(function(){ return {x: d3.select(this).attr("cx"), y:d3.select(this).attr("cy")}; })
                    .on("dragstart", function(d){

                          if((del_dot != null)&&((new Date()).getTime()-end_minis<300)){
                               begin_minis_again = (new Date()).getTime();
                               return;
                          }else{
                               begin_minis_again = 0;
                                  }

						var attrForm = document.getElementById('property-attrs');
						attrForm.innerHTML = "";
			        d3.select(this)  
			            .attr("stroke", "red"); 
                          arcs.selectAll(".Box")
                              .attr("stroke", "black");
                        arcs.selectAll(".L_Box")
                              .attr("stroke", "blue");
                          arcs.selectAll(".Node")
                              .filter(function(e) {
	                            return (e.did != d.did);
	                               })
                              .attr("stroke", "black");
                          arcs.selectAll(".arc_line")
                              .attr("fill", "black");
                          arcs.selectAll(".arrow_line")
                              .attr("stroke", "blue");
                          arcs.selectAll(".straight_line")
                              .attr("stroke", "blue");

                          begin_minis = (new Date()).getTime();
                           })
                    .on("dragend", function(d){

                          if((del_dot != null)&&((new Date()).getTime()-begin_minis_again<300)){
                               Sub_Draw(d);
                               return;
                                   }

                          end_minis=(new Date()).getTime(); 
                          if(end_minis-begin_minis<300){ 
                              del_dot = d;
                              del_arcline = null;
                              del_line = null;
                              arc_line_box = null;
                              straight_line_box = null;
                              return;
                                  }

				  var rate1 = 0;
				  var rete2 = 0;

				  var d_x = d3.mouse(this)[0];
				  var d_y = d3.mouse(this)[1];
				  var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				  var l_sin = d_y/dist;
				  var a_sin = Math.asin(l_sin)+ Math.PI/2;
				  if(d_x<0){a_sin = Math.PI*2-a_sin;}

                          var target_area = null;
                          for(var e=0; e<data.length; e++){
		                  var x = data[e];
                              if(dist<x.outerRadius && dist>x.innerRadius && a_sin<x.endAngle && a_sin>x.startAngle){
					    target_area = x;
                                  rate1 = (dist-x.innerRadius)/(x.outerRadius-x.innerRadius);
                                  rate2 = (a_sin-x.startAngle)/(x.endAngle-x.startAngle);
				        }
                                   }

				var temp= JSON.parse(JSON.stringify(json_data));
				block_stack_undo.push(temp);

                          var origin_area = null;
                          var dot_goal = null;
                          for(var e=0; e<data.length; e++){
		                  var x = data[e];
                              if(d.id==x.id){
					    origin_area = x;
                                  var dots = origin_area.dot;
					    for(var n=0; n<dots.length; n++){
					        if(dots[n].did == d.did){ dot_goal=dots[n]; dots.splice(n, 1);}
					    }
				        }
                                   }

                          if(!origin_area){ 
		                  drawCircle(); 
		                  return;
		                   }

                          if(!target_area){ 
			            var dots = blank[0].dot;
				      dot_goal.id = 0;
                              dots.push(dot_goal);
		                  drawCircle(); 
		                  return;
		                   }


			        var dots = target_area.dot;
				  dot_goal.id = target_area.id;
				  dot_goal.rate1 = rate1;
				  dot_goal.rate2 = rate2;
                          dots.push(dot_goal);
                          drawCircle(); 
                           })
                    .on("drag", function(d){
			      d3.select(this)  
			        .attr("cx", d3.event.x )  
			        .attr("cy", d3.event.y ); 
                           });

    var dot = dot_g.enter().append("g").attr("class", "Dot");
    dot.append("circle")
        .attr("class", "Node")
        .attr("cx", function(d){ return d.x; })  
        .attr("cy", function(d){ return d.y; })  
        .attr("r", 5)
        .attr("fill",function(d){	
             return color[d.level%9];
	   }) 
        .attr("stroke", "black")
        .call(dot_drag);

    dot.append("rect")
        .style('fill',function(d){  
             return color[d.level%9];
           })  
        .attr('x', function(d){
             var a1 = d.x;
             if(a1<0){
                 return a1-rect_w-5;
             }else{
                 return a1+5;
                 }
           })  
        .attr('y', function(d){
             var dist = Math.sqrt(d.x*d.x+d.y*d.y);
             var b1 = (dist+5)*d.y/dist;
             if(d.y<0){
                 return b1-rect_h/2;
             }else{
                 return b1-rect_h/2;
                 }
           })  
        .attr("stroke", "black")
        .attr('rx','4')      
        .attr('ry','4')  
        .attr('width',rect_w)  
        .attr('height',rect_h)
		.on("click", Edit)
        .append("title")
        .text(function(d) { return d.work; });

    var text=dot.append("text")
        .attr("class", 'Titletext') 
        .style("font-size", "12px") 
        .attr("text-anchor", "middle")   
        .attr('x', function(d){
             var a1 = d.x;
             if(a1<0){
                 return a1-rect_w/2-5 ;
             }else{
                 return a1+rect_w/2+5;
                 }
           })  
        .attr('y', function(d){
             var dist = Math.sqrt(d.x*d.x+d.y*d.y);
             var b1 = (dist+5)*d.y/dist;
             if(d.y<0){
                 return b1+4;
             }else{
                 return b1+4;
                 }
           }) 
        .on("click", Edit)
	  .text(function(d){  
             if(d.work.length>10){ return (d.work.substr(0,10)+'...'); }		
	       else{ return d.work; }	
	   })
        .append("title")
        .text(function(d) { return d.work; }); 

    dot_g.exit().transition()  
                .duration(400)    
                .remove();

//空白圆点
    arcs.selectAll("g.BlankDot").remove();
    var b_dot_g = arcs.selectAll("g.BlankDot").data(blank_dot_data);

    var b_dot_drag = d3.behavior.drag()
                    .origin(function(){ return {x: d3.select(this).attr("cx"), y:d3.select(this).attr("cy")}; } )
                    .on("dragstart", function(d){

                          if((del_dot != null)&&((new Date()).getTime()-end_minis<300)){
                               begin_minis_again = (new Date()).getTime();
                               return;
                          }else{
                               begin_minis_again = 0;
                                  }

						var attrForm = document.getElementById('property-attrs');
						attrForm.innerHTML = "";
			        d3.select(this)  
			            .attr("stroke", "red"); 
                          arcs.selectAll(".Node")
                              .filter(function(e) {
	                            return (e.did != d.did);
	                               })
                              .attr("stroke", "black");
                          arcs.selectAll(".Box")
                              .attr("stroke", "black");
                          arcs.selectAll(".L_Box")
                              .attr("stroke", "blue");
                          arcs.selectAll(".arc_line")
                              .attr("fill", "black");
                          arcs.selectAll(".arrow_line")
                              .attr("stroke", "blue");
                          arcs.selectAll(".straight_line")
                              .attr("stroke", "blue");

                          begin_minis = (new Date()).getTime();
                           })
                    .on("dragend", function(d){

                          if((del_dot != null)&&((new Date()).getTime()-begin_minis_again<300)){
                               Sub_Draw(d);
                               return;
                                   }

                          end_minis=(new Date()).getTime(); 
                          if(end_minis-begin_minis<300){ 
                              del_dot = d;
                              del_line = null;
                              del_arcline = null;
                              arc_line_box = null;
                              straight_line_box = null;
                              return;
                                  }
				  var rate1 = 0;
				  var rete2 = 0;

				  var d_x = d3.mouse(this)[0];
				  var d_y = d3.mouse(this)[1];
				  var dist = Math.sqrt(d_x*d_x+d_y*d_y);
				  var l_sin = d_y/dist;
				  var a_sin = Math.asin(l_sin)+ Math.PI/2;
				  if(d_x<0){a_sin = Math.PI*2-a_sin;}

                          if(dist<d.outerRadius && dist>d.innerRadius && a_sin<d.endAngle && a_sin>d.startAngle){
		                  drawCircle(); 
                              return;
                                   }

                          var target_area = null;
                          for(var e=0; e<data.length; e++){
		                  var x = data[e];
                              if(dist<x.outerRadius && dist>x.innerRadius && a_sin<x.endAngle && a_sin>x.startAngle){
					    target_area = x;
                                  rate1 = (dist-x.innerRadius)/(x.outerRadius-x.innerRadius);
                                  rate2 = (a_sin-x.startAngle)/(x.endAngle-x.startAngle);
				        }
                                   }

                          if(!target_area){ 
		                  drawCircle(); 
		                  return;
		                   }

				  var temp= JSON.parse(JSON.stringify(json_data));
				  block_stack_undo.push(temp);

                          var origin_area = null;
                          var dot_goal = null;

		                  var x = blank[0];
                              if(d.outerRadius<=x.outerRadius && d.innerRadius>=x.innerRadius && d.endAngle<=x.endAngle && d.startAngle>=x.startAngle){
					    origin_area = x;
                                  var dots = origin_area.dot;
					    for(var n=0; n<dots.length; n++){
					        if(dots[n].did == d.did){ 
                                          dot_goal=dots[n];
                                          dots.splice(n, 1);
                                                   }
					    }
				        }

                          if(!origin_area){ 
		                  drawCircle(); 
		                  return;
		                   }

			        var dots = target_area.dot;
				  dot_goal.id = target_area.id;
				  dot_goal.rate1 = rate1;
				  dot_goal.rate2 = rate2;

                          dots.push(dot_goal);
                          drawCircle(); 
                           })
                    .on("drag", function(d){
			      d3.select(this)  
			        .attr("cx", d3.event.x )  
			        .attr("cy", d3.event.y ); 
                           });

    var b_dot = b_dot_g.enter().append("g").attr("class", "BlankDot");
    b_dot.append("circle")
        .attr("class", "Node")
        .attr("cx", function(d){ return arc.centroid(d)[0]; })  
        .attr("cy", function(d){ return arc.centroid(d)[1]; })  
        .attr("r", 5)
        .attr("fill",function(d){	
            return "lightblue";
	   }) 
        .attr("stroke", "black")
        .call(b_dot_drag);

    b_dot.append("rect")
        .attr("fill",function(d){	
            return "lightblue";
	   }) 
        .attr('x', function(d){
             var a1 = arc.centroid(d)[0];
             if(a1<0){
                 return a1-rect_w-5;
             }else{
                 return a1+5;
                 }
           })  
        .attr('y', function(d){
             var dist = Math.sqrt(arc.centroid(d)[0]*arc.centroid(d)[0]+arc.centroid(d)[1]*arc.centroid(d)[1]);
             var b1 = (dist+5)*arc.centroid(d)[1]/dist;
             if(arc.centroid(d)[1]<0){
                 return b1-rect_h/2;
             }else{
                 return b1-rect_h/2;
                 }
           })  
        .attr("stroke", "black")
        .attr('rx','4')      
        .attr('ry','4')  
        .attr('width',rect_w)  
        .attr('height',rect_h)
		.on("click", Edit)
        .append("title")
        .text(function(d) { return d.work; });

    var text=b_dot.append("text")
        .attr("class", 'Titletext') 
        .style("font-size", "12px") 
        .attr("text-anchor", "middle")   
        .attr('x', function(d){
             var a1 = arc.centroid(d)[0];
             if(a1<0){
                 return a1-rect_w/2-5 ;
             }else{
                 return a1+rect_w/2+5;
                 }
           })  
        .attr('y', function(d){
             var dist = Math.sqrt(arc.centroid(d)[0]*arc.centroid(d)[0]+arc.centroid(d)[1]*arc.centroid(d)[1]);
             var b1 = (dist+5)*arc.centroid(d)[1]/dist;
             if(arc.centroid(d)[1]<0){
                 return b1+4;
             }else{
                 return b1+4;
                 }
           }) 
        .on("click", Edit)
	  .text(function(d){
		   if(d.work.length>10){ return (d.work.substr(0,10)+'...'); }		
	       else{ return d.work; }
	   })
        .append("title")
        .text(function(d) { return d.work; }); 

    b_dot_g.exit().transition()  
                .duration(400)    
                .remove();
}

//功能函数
window.addEventListener("load", function(){  

/*    d3.json("a.json", function(error, json){
        if(error){
            return console.error(error);
         }
        data = json.data;
        longitude = json.longitude;
        latitude = json.latitude;
        level = json.level;
        drawCircle();  
     });
*/
           latitude = [{"key":1,"startlongitude":1,"endlongitude":1,"Radius":20, "textbox":[]}];
	     var a1 = longi(-1);
	     var a2 = longi(1);
           var textbox = [{ "tid":1, 'tkey':1, 'r':(a1+a2)/2, 'arc':0, 'content':"请输入" }];

      src = {
            'longitude' : [{"key":1,"innerlatitude":1,"outerlatitude":-1,"Angle":0,"textbox":textbox}],
            'latitude' : [{"key":1,"startlongitude":1,"endlongitude":1,"Radius":20,"textbox":[]}],
	      'data':[], 
            'level' : 0,
            'info' : "根",
            'infonum' : 1,
            'blank' : [{"startAngle":4.7123889803847 ,"endAngle":6.2831853071796 , "dot":[]}],
            'dot_num' : 0,
            'line_num': 1,
            'arc_line_num':1,
            'block_num' : 0, 
            'text_num' : 0 
         };
      json_data = src;
      drawCircle();
});

Array.prototype.getID = function(val) {  
    for (var i = 0; i < this.length; i++) {  
    if (this[i].id == val) return this[i];  
    }  
    return -1;  
};

function Edit(d){
              arcs.selectAll(".Node")
			      .attr("stroke", "black");
			  arcs.selectAll(".Node")
				  .filter(function(e) {
					return (e.did == d.did);
					   })
				  .attr("stroke", "red");
			  arcs.selectAll(".Box")
				  .attr("stroke", "black");
			  arcs.selectAll(".L_Box")
				  .attr("stroke", "blue");
			  arcs.selectAll(".arc_line")
				  .attr("fill", "black");
			  arcs.selectAll(".arrow_line")
				  .attr("stroke", "blue");
			  arcs.selectAll(".straight_line")
				  .attr("stroke", "blue");
			  del_dot = d;
			  del_arcline = null;
			  del_line = null;
			  arc_line_box = null;
			  straight_line_box = null;

          var attrForm = document.getElementById('property-attrs');
	    attrForm.innerHTML = "";
	    var label = document.createElement('label');
	    label.textContent = "任务属性：";
	    var handle1 = document.createElement('textarea');
          handle1.value = d.work;
	    var btn = document.createElement('input');
          btn.type='button';
          btn.setAttribute("style","background:url(icon/commit.png); border-style:2px; background-size:100% 100%; width:25px; height:25px; ");
          btn.addEventListener('click', function(){
		      var rate1 = handle1.value;
		      if(!rate1) return;

			var temp= JSON.parse(JSON.stringify(json_data));
			block_stack_undo.push(temp);

                  d.work = handle1.value;
				  attrForm.innerHTML = "";
		      drawCircle();
                  
              });
          attrForm.appendChild(label);
          attrForm.appendChild(handle1);
	    attrForm.appendChild(btn);
		  handle1.focus();
}

function Show_info(d){
          var attrForm = document.getElementById('property-attrs');
	    attrForm.innerHTML = "";
	    var label = document.createElement('label');
		if(d.innerRadius)
	        label.textContent = "经线属性：";
		else
	        label.textContent = "纬线属性：";
	    var handle1 = document.createElement('textarea');
          handle1.value = d.content;
	    var btn = document.createElement('input');
          btn.type='button';
          btn.setAttribute("style","background:url(icon/commit.png); border-style:2px; background-size:100% 100%; width:25px; height:25px; ");
          btn.addEventListener('click', function(){
		      var rate1 = handle1.value;
		      if(!rate1) return;

                  var temp= JSON.parse(JSON.stringify(json_data));
                  block_stack_undo.push(temp);

                  d.content = handle1.value;
		      attrForm.innerHTML = "";
		      drawCircle();
              });
          attrForm.appendChild(label);
          attrForm.appendChild(handle1);
	    attrForm.appendChild(btn);
	    handle1.focus();
}


function remove_l(key){
    for(var i=0; i<longitude.length; i++){
        if(longitude[i].innerlatitude==key || longitude[i].outerlatitude==key ){
            var p = longitude[i].key;
            longitude.splice(i, 1);
            remove_a(p);

            i -= 1;

            var confer = [];
	  	for(var i=0; i<data.length; i++){
                if(data[i].endlongitude==p){
                    confer.push(data[i]);
                     }
		}

            for(var i=0; i<confer.length; i++){
	  	    for(var j=0; j<data.length; j++){
                    if(confer[i].innerlatitude==data[j].innerlatitude && confer[i].outerlatitude==data[j].outerlatitude && 
                       confer[i].endlongitude==data[j].startlongitude){
                        confer[i].endlongitude=data[j].endlongitude;
                        for(var x=0;x<data[j].dot.length; x++){
                            confer[i].dot.push(data[j].dot[x]);
                                }
                        data.splice(j, 1);
                        break;
                           }
		      }
		 }
           }
     }
    return;
}

function remove_a(key){
    for(var i=0; i<latitude.length; i++){
        if(latitude[i].startlongitude==key || latitude[i].endlongitude==key ){
            var p = latitude[i].key;
            latitude.splice(i, 1);
            remove_l(p);

            i -= 1;

            var confer = [];
	  	for(var i=0; i<data.length; i++){
                if(data[i].outerlatitude==p){
                    confer.push(data[i]);
                       }
		 }

            for(var i=0; i<confer.length; i++){
	  	    for(var j=0; j<data.length; j++){
                    if(confer[i].startlongitude==data[j].startlongitude && confer[i].endlongitude==data[j].endlongitude && 
                       confer[i].outerlatitude==data[j].innerlatitude){
                        confer[i].outerlatitude=data[j].outerlatitude;
                        for(var x=0;x<data[j].dot.length; x++){
                            confer[i].dot.push(data[j].dot[x]);
                                }
                        data.splice(j, 1);
                        break;
                          }
		     }
		}
           }
     }
    return;
}



$(document).ready(function(){ 
	//保存
	$('#button13').click(function (){ 
		var datastr = JSON.stringify(src.data);
		var longitudestr = JSON.stringify(src.longitude);
		var latitudestr = JSON.stringify(src.latitude);
		var levelstr = JSON.stringify(src.level);
		var infostr = JSON.stringify(src.info);
		var infonumstr = JSON.stringify(src.infonum);
		var blankstr = JSON.stringify(src.blank);
		var dot_num_str = JSON.stringify(src.dot_num);
		var line_num_str = JSON.stringify(src.line_num);
		var arc_line_num_str = JSON.stringify(src.arc_line_num);
		var block_num_str = JSON.stringify(src.block_num);
		var text_num_str = JSON.stringify(src.text_num);

		var content = "{\"data\":" + datastr + ",\"longitude\":" + longitudestr + ",\"latitude\":" + latitudestr + ",\"level\":" +
                          levelstr + ",\"info\":" + infostr + ",\"infonum\":" + infonumstr +",\"blank\":" + blankstr + ",\"dot_num\":" + dot_num_str + 
                          ",\"line_num\":" + line_num_str + ",\"arc_line_num\":" + arc_line_num_str + ",\"block_num\":" + block_num_str +
                          ",\"text_num\":" + text_num_str + "}";
		var blob = new Blob([content], {type: "text/plain;charset=utf-8"});
		saveAs(blob, "down.json");//"file.txt");
	});
    //添加外弧
    $('#button12').click(function (){ 
        outer_draw = true;
        cut = false;
        cut_arc = false;
        $("#button6").css("background-color", "rgb(246,246,245)");
        $("#button8").css("background-color", "rgb(246,246,245)");
        $("#button12").css("background-color", "red");
     });
	//新建
    $('#button10').click(function (){

           latitude = [{"key":1,"startlongitude":1,"endlongitude":1,"Radius":20, "textbox":[]}];
 	     var a1 = longi(-1);
	     var a2 = longi(1);
           var textbox = [{ "tid":1, 'tkey':1, 'r':(a1+a2)/2, 'arc':0, 'content':"请输入" }];
        
            src = {
            'longitude' : [{"key":1,"innerlatitude":1,"outerlatitude":-1,"Angle":0, "textbox":textbox}],
            'latitude' : [{"key":1,"startlongitude":1,"endlongitude":1,"Radius":20, "textbox":[]}],
	      'data':[], 
            'level' : 0,
            'info' : "根",
            'infonum' : 1,
            'blank' : [{"startAngle":4.7123889803847 ,"endAngle":6.2831853071796 , "dot":[]}],
            'dot_num' : 0,
            'line_num': 1,
            'arc_line_num':1,
            'block_num' : 0 ,
            'text_num' : 1 };
            json_data = src;
            block_stack_undo = [];
            block_stack_redo = [];
            drawCircle();
     });
	//前进
    $('#button1').click(function (){

		if(block_stack_undo.length<1){ return ;}

		var temp= JSON.parse(JSON.stringify(json_data));

		block_stack_redo.push(temp);
		json_data = block_stack_undo.pop();

            drawCircle();
     });
	//后退
    $('#button2').click(function (){

		if(block_stack_redo.length<1){ return ;}

		var temp= JSON.parse(JSON.stringify(json_data));
		block_stack_undo.push(temp);
		json_data = block_stack_redo.pop();

            drawCircle();
     });
	//删除
    $('#button3').click(function (){
            if(del_dot!=null){

                var temp= JSON.parse(JSON.stringify(json_data));
                block_stack_undo.push(temp);

                for(var e=0; e<data.length; e++){
		        var dots = data[e].dot;
		        for(var n=0; n<dots.length; n++){
		            if(dots[n].did == del_dot.did){ dot_goal=dots[n]; dots.splice(n, 1);}
		          }
		     }

	          var dots = blank[0].dot;
		    for(var n=0; n<dots.length; n++){
		        if(dots[n].did == del_dot.did){ dot_goal=dots[n]; dots.splice(n, 1);}
		     }
                del_dot=null;
                drawCircle(); 
		    return;
                }
            if(del_arcline!=null){
                if(del_arcline.key!=1){
                var temp= JSON.parse(JSON.stringify(json_data));
                block_stack_undo.push(temp);

                var temp = 0;
                for(var e=0; e<latitude.length; e++){
                    if(latitude[e].key==del_arcline.key){
                        temp=e;
                          }
		     }
                var a_key = latitude[temp].key;
                latitude.splice(temp, 1);
                remove_l(a_key);

                var confer = [];
	  	    for(var i=0; i<data.length; i++){
                    if(data[i].outerlatitude==a_key){
                        confer.push(data[i]);
                           }
		     }

                for(var i=0; i<confer.length; i++){
	  	        var flag = 0;
	  	        for(var j=0; j<data.length; j++){
                        if(confer[i].startlongitude==data[j].startlongitude && confer[i].endlongitude==data[j].endlongitude && 
                           confer[i].outerlatitude==data[j].innerlatitude){
                            confer[i].outerlatitude=data[j].outerlatitude;
                            for(var x=0;x<data[j].dot.length; x++){
                                confer[i].dot.push(data[j].dot[x]);
                                     }
                            data.splice(j, 1);
                            flag = 1;
                            break;
                               }
		          }
                    if(flag==0){
	  	            for(var j=0; j<data.length; j++){
                            if(confer[i].id==data[j].id){
                                data.splice(j, 1);
                                break;
                                     }
		               }

                          }
		     }

                del_arcline=null;
                drawCircle();     
		    return;
                }
			}

            if(del_line!=null){
                if(del_line.key!=1){
                var temp= JSON.parse(JSON.stringify(json_data));
                block_stack_undo.push(temp);

                var temp = 0;
                for(var e=0; e<longitude.length; e++){
                    if(longitude[e].key==del_line.key){
                        temp=e;
                          }
		     }
                var l_key = longitude[temp].key;
                longitude.splice(temp, 1);
                remove_a(l_key);

                var confer = [];
	          for(var i=0; i<data.length; i++){
                    if(data[i].endlongitude==l_key){
                        confer.push(data[i]);
                          }
		     }

                for(var i=0; i<confer.length; i++){
	  	        for(var j=0; j<data.length; j++){
                        if(confer[i].innerlatitude==data[j].innerlatitude && confer[i].outerlatitude==data[j].outerlatitude && 
                           confer[i].endlongitude==data[j].startlongitude){
                            confer[i].endlongitude=data[j].endlongitude;
                            for(var x=0;x<data[j].dot.length; x++){
                                confer[i].dot.push(data[j].dot[x]);
                                     }
                            data.splice(j, 1);
                            break;
                                }
		           }
		     }

                del_arcline=null;
                drawCircle();     
		    return;
                }
			}


            if(arc_line_box!=null){

                var temp= JSON.parse(JSON.stringify(json_data));
                block_stack_undo.push(temp);

                for(var e=0; e<latitude.length; e++){
		        var textbox = latitude[e].textbox;
		        for(var n=0; n<textbox.length; n++){
		            if(textbox[n].tid == arc_line_box.tid){ textbox.splice(n, 1);}
		          }
		     }

                arc_line_box=null;
                drawCircle(); 
		    return;
                }



            if(straight_line_box!=null){

                var temp= JSON.parse(JSON.stringify(json_data));
                block_stack_undo.push(temp);

                for(var e=0; e<longitude.length; e++){
		        var textbox = longitude[e].textbox;
		        for(var n=0; n<textbox.length; n++){
		            if(textbox[n].tid == straight_line_box.tid){ textbox.splice(n, 1);}
		          }
		     }

                straight_line_box=null;
                drawCircle(); 
		    return;
                }


     });

	//添加任务
    $('#button4').click(function (){

        var temp= JSON.parse(JSON.stringify(json_data));
        block_stack_undo.push(temp);
        blank[0].dot.push({ 'did':json_data.dot_num+1, 'id':0, 'work':'请输入', 'children':[] });
        json_data.dot_num += 1;

	  drawCircle();
     });
	//添加射线、线段
    $('#button6').click(function (){
        cut = true;
        cut_arc = false;
        outer_draw = false;
        $("#button6").css("background-color", "red");
        $("#button8").css("background-color", "rgb(246,246,245)");
        $("#button12").css("background-color", "rgb(246,246,245)");
     });
	//添加内弧
    $('#button8').click(function (){
        cut = false;
        cut_arc = true;
        outer_draw = false;
        $("#button6").css("background-color", "rgb(246,246,245)");
        $("#button8").css("background-color", "red");
        $("#button12").css("background-color", "rgb(246,246,245)");
     });
	//添加线属性
    $('#button20').click(function (){
            if(del_arcline!=null){
                if(del_arcline.key==1){ return; }
                del_arcline.textbox.push({ "tid":json_data.text_num+1, 'tkey':del_arcline.key, 'r':del_arcline.Radius,'rate':0.5,
                   'arc':(del_arcline.startAngle+del_arcline.endAngle)/2, 'content':"请输入" });

                json_data.text_num += 1;
                del_arcline=null;
                drawCircle();     
		    return;
                }
            if(del_line!=null){
                del_line.textbox.push({ "tid":json_data.text_num+1, 'tkey':del_line.key, 'r':(del_line.innerRadius+del_line.outerRadius)/2,
                   'arc':del_line.Angle, 'content':"请输入" });

                json_data.text_num += 1;
                del_line=null;
                drawCircle();     
		    return;
                }
     });

});



function mousemove(){

    if(draw_outer_arc == true){
	    var d_x = d3.mouse(this)[0]-width/2;
	    var d_y = d3.mouse(this)[1]-height/2;

	    var dist = Math.sqrt(d_x*d_x+d_y*d_y);
          var l_sin = d_y/dist;
          var a_sin = Math.asin(l_sin)+ Math.PI/2;
          if(d_x<0){a_sin = Math.PI*2-a_sin;}

	    var max_r = 0;

          var chosen = [];
	    for(var i=0; i<line_arrow.length; i++){
		if((line_arrow[i].Angle>=outer_arc_start_a)&&(line_arrow[i].Angle<a_sin)){
		    chosen.push(line_arrow[i].key);
		  }
	     }

	    for(var j=0; j<chosen.length; j++){
		    for(i=0; i<data.length; i++) {
			  if((data[i].outerRadius>max_r)&&(data[i].startlongitude==chosen[j])){
				 max_r=data[i].outerRadius;
			  }
		     }
	     }

	    if(dist<max_r){ return; }

	    var pi2 = Math.PI/2;
	    var arrow_l = arcs.selectAll("g.Arrowline").select("line")
                  .filter(function(d){ 
                      for(var i=0; i<chosen.length; i++){
                          if(d.key == chosen[i]){ return true; }
                             }
                      return false;
                        })
		      .attr("x2" ,function(d){  		
			    return (dist+30)*Math.cos(d.Angle-pi2);
			})  
		      .attr("y2" ,function(d){   				
			    return (dist+30)*Math.sin(d.Angle-pi2);
			});

          var anglePath = d3.svg.arc()
		     .outerRadius(dist+1)
		     .innerRadius(dist)
		     .startAngle(outer_arc_start_a)
		     .endAngle(a_sin);
          drag_outer_arc.attr("class", "Commun")
		     .attr("d", anglePath)
		     .style("stroke", "#0000E3");
    }

    if(draw_line == true){
	    var d_x = d3.mouse(this)[0]-width/2;
	    var d_y = d3.mouse(this)[1]-height/2;
	    var d_r = line_start_r;
	    var dist = Math.sqrt(d_x*d_x+d_y*d_y);
	    var sourcex = 0+d_r*(d_x-0)/dist;
	    var sourcey = 0+d_r*(d_y-0)/dist;
	    drag_line.attr("x1", sourcex)  
		      .attr("y1", sourcey)   
		      .attr("x2" ,function(d){   		
			    return d3.mouse(this)[0];
			})  
		      .attr("y2" ,function(d){   		
			    return d3.mouse(this)[1];
			});
    }

    if(draw_arc == true){
	    var d_x = d3.mouse(this)[0]-width/2;
	    var d_y = d3.mouse(this)[1]-height/2;
	    var d_a = arc_start_a;
	    var dist = Math.sqrt(d_x*d_x+d_y*d_y);
          if(line_i+5>dist){ dist=line_i+5;}
          if(line_o-5<dist){ dist=line_o-5;}
draw_arc_ext = dist;
          var l_sin = d_y/dist;
          var a_sin = Math.asin(l_sin)+ Math.PI/2;
          if(d_x<0){a_sin = Math.PI*2-a_sin;}
          var anglePath = d3.svg.arc()
		     .outerRadius(dist+1)
		     .innerRadius(dist)
		     .startAngle(d_a)
		     .endAngle(a_sin);
          drag_arc.attr("class", "Commun")
		     .attr("d", anglePath)
		     .style("stroke", "#0000E3")
		     .style("fill", "#0000E3");
    }
}

function mouseup(){

    if(outer_draw==true){ 
	    if(draw_outer_arc == false) return;
	    drag_outer_arc.remove();
	    drag_outer_arc = null;
	    draw_outer_arc = false;

          var d_x = d3.mouse(this)[0]-width/2;
	    var d_y = d3.mouse(this)[1]-height/2;
    	    var dist = Math.sqrt(d_x*d_x+d_y*d_y);
	    var max_r = 0;

          var temp= JSON.parse(JSON.stringify(json_data));
          block_stack_undo.push(temp);

	    var l_sin = d_y/dist;
	    var a_sin = Math.asin(l_sin)+ Math.PI/2;
	    if(d_x<0){a_sin = Math.PI*2-a_sin;}

	    var delta = 2048;
	    var min_a = 0;
          var min_key = 0;   
          var chosen = [];

	    for(var i=0; i<line_arrow.length; i++){
		if((a_sin<line_arrow[i].Angle)&&(line_arrow[i].Angle-a_sin<delta)){
		    delta = line_arrow[i].Angle-a_sin;
		    min_a = line_arrow[i].Angle;
		    min_key = line_arrow[i].key;
		  }
		if((line_arrow[i].Angle>=outer_arc_start_a)&&(line_arrow[i].Angle<a_sin)){
		    chosen.push(line_arrow[i]);
		  }
	     }

	    for(var j=0; j<chosen.length; j++){
		    for(i=0; i<data.length; i++) {
			  if((data[i].outerRadius>max_r)&&(data[i].startlongitude==chosen[j].key)){
				 max_r=data[i].outerRadius;
			  }
		     }
	     }
	    if(dist<max_r){ return; }

          var data_len = data.length;
	    for(i=0; i<chosen.length; i++){
                var temp_r = 0;
                var temp_s = 0;
                var temp_e = 0;
                var temp_i = 0;
                if(data_len==0){

                    data.push({ "id":json_data.block_num +1, "level":json_data.level+1, "startlongitude":1, "endlongitude":1, 
                                "innerlatitude":1, "outerlatitude":json_data.arc_line_num+1,
		                    "dot":[] });
                    json_data.block_num += 1;

                }else{
		        for(j=0; j<data.length; j++){
                        if((data[j].startlongitude == chosen[i].key)&&(data[j].outerRadius>temp_r)){
                            temp_r = data[j].outerRadius;
                            temp_s = chosen[i].key;
                            temp_i = data[j].outerlatitude;
                              }
                         }
                    var delta = 2048;
                    for(k=0; k<line_arrow.length; k++){
                        if((line_arrow[k].key!=chosen[i].key)&&(line_arrow[k].Angle-chosen[i].Angle>0)&&(line_arrow[k].Angle-chosen[i].Angle<delta)){
                            delta = line_arrow[k].Angle-chosen[i].Angle;
                            temp_e = line_arrow[k].key;
                              }     
                         }
                    if(temp_e==0){
                        temp_e = 1; 
                         }
                    data.push({ "id":json_data.block_num+1, "level":json_data.level+1, "startlongitude":temp_s, "endlongitude":temp_e, 
                                "innerlatitude":temp_i, "outerlatitude":json_data.arc_line_num+1,
		                    "dot":[] });
                    json_data.block_num += 1;
                      }
              }

          if(min_a==0){ 
              min_key = 1; 
              if(outer_arc_start_a==0){
                  json_data.level += 1;
                  }
             }

          var a1 = start(outer_arc_start_key);
          var a2 = end(min_key);

          var textbox = [{ "tid":json_data.text_num+1, 'tkey':json_data.arc_line_num+1, 'r':dist, 'rate':0.5,
                           'arc':(a1+a2)/2, 'content':"请输入" }];
          json_data.text_num += 1;

          var temp = {"key":json_data.arc_line_num+1, "startlongitude":outer_arc_start_key, "endlongitude":min_key, "Radius":dist, "textbox":textbox};
          latitude.push(temp);

          json_data.arc_line_num += 1;
          outer_draw = false;
          $("#button12").css("background-color", "rgb(246,246,245)");
	    drawCircle();

    }

    if(cut == true){
	    if(draw_line == false) return;
	    drag_line.remove();
	    drag_line = null;
	    draw_line = false;

	    var temp= JSON.parse(JSON.stringify(json_data));
	    block_stack_undo.push(temp);

	    var d_x = d3.mouse(this)[0]-width/2;
	    var d_y = d3.mouse(this)[1]-height/2;
	    var line_end_r = Math.sqrt(d_x*d_x+d_y*d_y);
	    if(line_end_r<line_start_r){ return; }
	    var l_sin = d_y/line_end_r;
	    var a_sin = Math.asin(l_sin)+ Math.PI/2;
	    if(d_x<0){a_sin = Math.PI*2-a_sin;}

	    var chosen = [];
	    for(var i=0; i<data.length; i++){
		var x = data[i];
		if((x.startAngle<a_sin)&&(x.endAngle>a_sin)){
		    if((x.innerRadius<line_end_r && x.outerRadius>line_end_r)||(x.innerRadius>=line_start_r && x.outerRadius<line_end_r)){
		        chosen.push(x);
		        }
		  }
	      }

	    var delta = Math.PI*2;
	    var tween = a_sin;
          var min_r =2048;
          var max_r =0;
          var max_sr =0;
          var max_sr =0;
	    for(var a=0; a<chosen.length; a++){
			var sA = chosen[a].startAngle;
		      var eA = chosen[a].endAngle;
		      if(delta>=eA-sA){
		          delta = eA-sA;
                      if(tween-sA<0.1){ tween=sA+0.1; }
                      if(eA-tween<0.1){ tween=eA-0.1; }
		        }
                  if(min_r>chosen[a].innerRadius){
                      min_r = chosen[a].innerRadius;
                      min_sr = chosen[a].innerlatitude;
                        }
                  if(max_r<chosen[a].outerRadius){
                      max_r = chosen[a].outerRadius;
                      max_sr = chosen[a].outerlatitude;
                        }
	     }

          if(max_r<line_end_r){

		  var a1 = longi(min_sr);
		  var a2 = longi(-1);

		  var textbox = [{ "tid":json_data.text_num+1, 'tkey':json_data.line_num+1, 'r':(a1+a2)/2,
		                   'arc':tween, 'content':"请输入" }];
		  json_data.text_num += 1;

              longitude.push({"key":json_data.line_num+1, "innerlatitude":min_sr, "outerlatitude":-1, "Angle":tween,"textbox":textbox});
              json_data.line_num += 1;
          }else{
		  var a1 = longi(min_sr);
		  var a2 = longi(max_sr);

		  var textbox = [{ "tid":json_data.text_num+1, 'tkey':json_data.line_num+1, 'r':(a1+a2)/2,
		                   'arc':tween, 'content':"请输入" }];
		  json_data.text_num += 1;
              longitude.push({"key":json_data.line_num+1, "innerlatitude":min_sr, "outerlatitude":max_sr, "Angle":tween,"textbox":textbox});
              json_data.line_num += 1;
             }
	    for(var a=0; a<chosen.length; a++){
              var endline = chosen[a].endlongitude;
	        chosen[a].endlongitude = json_data.line_num;

              var x = chosen[a].dot;
              var y = [];
              for(var v=0;v<x.length;v++){
                  var temp = null;
                  if(((chosen[a].endAngle-chosen[a].startAngle)*x[v].rate2+chosen[a].startAngle)>tween){
                      temp = x[v];
                      x.splice(v, 1);
                      y.push(temp);
                        }
                  }
              data.push({ "id":json_data.block_num+1,"level":chosen[a].level, "startlongitude":json_data.line_num, "endlongitude":endline,
                          "innerlatitude":chosen[a].innerlatitude, "outerlatitude":chosen[a].outerlatitude,
                          "dot":y });
              json_data.block_num += 1;
	     }
          cut = false;
          $("#button6").css("background-color", "rgb(246,246,245)");
	    drawCircle();
     }

    if(cut_arc == true){
	    if(draw_arc == false) return;
	    drag_arc.remove();
	    drag_arc = null;
	    draw_arc = false;

	    var temp= JSON.parse(JSON.stringify(json_data));
          block_stack_undo.push(temp);

	    var d_x = d3.mouse(this)[0]-width/2;
	    var d_y = d3.mouse(this)[1]-height/2;
	    var arc_r = Math.sqrt(d_x*d_x+d_y*d_y);
	    var l_sin = d_y/arc_r;
	    var a_sin = Math.asin(l_sin)+ Math.PI/2;
	    if(d_x<0){ a_sin = Math.PI*2-a_sin; }

arc_r = draw_arc_ext;
draw_arc_ext = 0;

	    var chosen = [];
	    for(var i=0; i<data.length; i++){
		var x = data[i];
		if((x.innerRadius<arc_r)&&(x.outerRadius>arc_r)){
		    if((x.startAngle<a_sin && x.endAngle>a_sin)||(x.startAngle>=arc_start_a && x.endAngle<a_sin)){
		        chosen.push(x);
		        }
		  }
	      }
	    var delta = 1024*4;
	    var tween = arc_r;
          var max_a = 0;
          var min_a = 2048;
          var max_sa =0;
          var max_sa =0;

	    for(var a=0; a<chosen.length; a++){
			var ir = chosen[a].innerRadius;
		      var or = chosen[a].outerRadius;
		      if(delta>or-ir){
		          delta = or-ir;
                      if(tween-ir<10){ tween=ir+10; }
                      if(or-tween<10){ tween=or-10; }
		        }
		      if(min_a>chosen[a].startAngle){
		          min_a = chosen[a].startAngle;
		          min_sa = chosen[a].startlongitude;
		        }
		      if(max_a<chosen[a].endAngle){
		          max_a = chosen[a].endAngle;
		          max_sa = chosen[a].endlongitude;
		        }
	     }

          var a1 = start(min_sa);
          var a2 = end(max_sa);

          var textbox = [{ "tid":json_data.text_num+1, 'tkey':json_data.arc_line_num+1, 'r':tween,'rate':0.5,
                           'arc':(a1+a2)/2, 'content':"请输入" }];
          json_data.text_num += 1;

          latitude.push({ "key":json_data.arc_line_num+1, "startlongitude":min_sa, "endlongitude":max_sa, "Radius":tween,"textbox":textbox});
          json_data.arc_line_num += 1;
	    for(var a=0; a<chosen.length; a++){
              var endline = chosen[a].outerlatitude;
	        chosen[a].outerlatitude = json_data.arc_line_num;

              var x = chosen[a].dot;
              var y = [];
              for(var v=0;v<x.length;v++){
                  var temp = null;
                  if(((chosen[a].outerRadius-chosen[a].innerRadius)*x[v].rate1+chosen[a].innerRadius)>tween){
                      temp = x[v];
                      x.splice(v, 1);
                      y.push(temp);
                        }
                  }

              data.push({ "id":json_data.block_num+1,"level":chosen[a].level, "startlongitude":chosen[a].startlongitude, "endlongitude":chosen[a].endlongitude,
                          "innerlatitude":json_data.arc_line_num, "outerlatitude":endline,
                          "dot":y });
              json_data.block_num += 1;
	     }
          cut_arc = false;
          $("#button8").css("background-color", "rgb(246,246,245)");
	    drawCircle();
     }
}


function mousedown(){
    if(outer_draw==false){ return; }
    var d_x = d3.mouse(this)[0]-width/2;
    var d_y = d3.mouse(this)[1]-height/2;
    var dist = Math.sqrt(d_x*d_x+d_y*d_y);
    var max_r = 0;

    var l_sin = d_y/dist;
    var a_sin = Math.asin(l_sin)+ Math.PI/2;
    if(d_x<0){a_sin = Math.PI*2-a_sin;}
    var delta = 2048;
    var min_a = 0;
    for(var i=0; i<line_arrow.length; i++){
        if((a_sin>line_arrow[i].Angle)&&(a_sin-line_arrow[i].Angle<delta)){
            delta = a_sin-line_arrow[i].Angle;
            min_a = line_arrow[i].Angle;
            outer_arc_start_key = line_arrow[i].key;
          }
     }
    outer_arc_start_a = min_a;

    for(i=0; i<data.length; i++) {
	  if((data[i].outerRadius>max_r)&&(data[i].startlongitude==outer_arc_start_key)){
		 max_r=data[i].outerRadius;
	  }
     }
    if(dist<max_r){ return; }
    draw_outer_arc = true;


    var pi2 = Math.PI/2;
    var arrow_l = arcs.selectAll("g.Arrowline").select("line")
            .filter(function(d){ return (d.Angle==outer_arc_start_a); })
	      .attr("x2" ,function(d){		
		    return (dist+30)*Math.cos(d.Angle-pi2);
		})  
	      .attr("y2" ,function(d){ 				
		    return (dist+30)*Math.sin(d.Angle-pi2);
		});

    var anglePath = d3.svg.arc()
		     .outerRadius(dist+1)
		     .innerRadius(dist)
		     .startAngle(min_a)
		     .endAngle(a_sin);
    drag_outer_arc = svg.append("path")
		     .attr("class", "Commun")
		     .attr("d", anglePath)
		     .style("stroke", "#0000E3");
}

function Sub_Draw(obj){

    if(obj.children.length<1){
           latitude = [{"key":1,"startlongitude":1,"endlongitude":1,"Radius":20, "textbox":[]}];
 	     var a1 = longi(-1);
	     var a2 = longi(1);
           var textbox = [{ "tid":1, 'tkey':1, 'r':(a1+a2)/2, 'arc':0, 'content':"请输入" }];
        
           obj.children = [{
            'longitude' : [{"key":1,"innerlatitude":1,"outerlatitude":-1,"Angle":0, "textbox":textbox}],
            'latitude' : [{"key":1,"startlongitude":1,"endlongitude":1,"Radius":20, "textbox":[]}],
	      'data':[], 
            'level' : 0,
            'info' : "任务",
            'infonum' : json_data.infonum+1,
            'blank' : [{"startAngle":4.7123889803847 ,"endAngle":6.2831853071796 , "dot":[]}],
            'dot_num' : 0,
            'line_num': 1,
            'arc_line_num':1,
            'block_num' : 0 ,
            'text_num' : 1 }];
     }

    pre_data.push(json_data);
    json_data = obj.children[0];
    drawCircle();

}

main.on('mousemove', mousemove)
    .on('mouseup', mouseup)
    .on('mousedown', mousedown);

</script>
</html>
